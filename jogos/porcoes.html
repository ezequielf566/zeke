<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>La Saga de Jos√© - Versi√≥n Final</title>
    <style>
        :root { --gold: #f1c40f; --neon-green: #2ecc71; --red: #ff4757; }
        body, html { 
            margin: 0; padding: 0; width: 100%; height: 100%; 
            overflow: hidden; background: #000; font-family: 'Georgia', serif;
            user-select: none; -webkit-user-select: none;
        }

        #game-container {
            width: 100vw; height: 100vh;
            background: url('../fundo.jpg') center/cover no-repeat;
            position: relative; overflow: hidden;
            display: none; touch-action: none;
            transition: filter 1.2s linear;
            padding-bottom: env(safe-area-inset-bottom);
        }
        
        /* MEN√ö RESPONSIVO */
        #main-menu {
            width: 100vw; height: 100vh;
            background: linear-gradient(rgba(0,0,0,0.6), rgba(0,0,0,0.6)), url('../fundo.jpg') center/cover;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            position: absolute; z-index: 500; text-align: center;
            padding-bottom: 40px;
        }
        #menu-logo { width: 160px; margin-bottom: 20px; filter: drop-shadow(0 0 15px var(--gold)); }
        .menu-group { display: flex; flex-direction: column; gap: 12px; width: 280px; }

        .menu-btn {
            padding: 15px; border-radius: 50px; border: 2px solid var(--gold);
            background: rgba(0,0,0,0.8); color: white; font-weight: bold; cursor: pointer;
            transition: 0.3s; font-size: 16px;
        }
        .menu-btn:hover { background: var(--gold); color: black; }
        .btn-survival { border-color: var(--neon-green); }

        /* HUD Y UI */
        #ui-header { position: absolute; top: 15px; width: 100%; display: flex; flex-direction: column; align-items: center; z-index: 100; pointer-events: none; }
        #hud { width: 90%; display: flex; justify-content: space-between; align-items: center; pointer-events: auto; }
        .hud-item {
            background: rgba(0,0,0,0.7); backdrop-filter: blur(8px);
            padding: 8px 15px; border-radius: 8px; border: 1px solid var(--gold);
            color: white; font-weight: bold; font-size: 14px; min-width: 80px; text-align: center;
        }

        #progress-wrapper { width: 80%; height: 12px; background: rgba(0,0,0,0.7); border-radius: 50px; border: 1px solid rgba(255,255,255,0.3); position: relative; margin-top: 10px; }
        #progress-fill { height: 100%; width: 0%; background: linear-gradient(90deg, #1e8449, #f1c40f); border-radius: 50px; transition: width 0.5s linear; }
        #walker-container { position: absolute; left: 0%; top: 50%; transform: translate(-50%, -50%); width: 35px; height: 35px; transition: left 0.5s linear; }

        /* --- AVISO DE ORIENTACI√ìN --- */
        #orientation-warning {
            display: none; 
            position: absolute;
            top: 140px; 
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255, 255, 255, 0.85);
            color: #2c1e14;
            padding: 8px 20px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: bold;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            z-index: 400;
            pointer-events: none;
            white-space: nowrap;
            animation: floatWarn 2s ease-in-out infinite;
        }
        @keyframes floatWarn { 0%, 100% {transform: translate(-50%, 0);} 50% {transform: translate(-50%, -5px);} }
        
        @media (orientation: portrait) {
            #orientation-warning { display: block; }
        }

        /* PERSONAJES Y ELEMENTOS */
        #player { width: 110px; height: 110px; position: absolute; left: 12%; z-index: 50; pointer-events: none; }
        #chao { position: absolute; bottom: 0; width: 100%; height: 140px; background: linear-gradient(to bottom, #1e3d1a, #2c1e14); z-index: 10; }
        
        /* --- ARCA RESPONSIVA --- */
        #arca-final { 
            position: absolute; 
            bottom: 80px; 
            right: -1000px; 
            z-index: 40; 
            transition: right 4s ease-out;
            width: auto;
            height: auto;
            max-width: 45vw;  
            max-height: 50vh; 
        }

        .rock { position: absolute; width: 55px; height: 55px; background: #333; border-radius: 12px; z-index: 30; }
        .rock-glow { background: var(--gold) !important; box-shadow: 0 0 25px var(--gold); }

        #story-msg { position: absolute; top: 25%; width: 100%; text-align: center; color: white; font-size: 22px; font-weight: bold; text-shadow: 2px 2px 5px #000; opacity: 0; z-index: 150; transition: opacity 0.5s; pointer-events:none; }
        #story-msg.active { opacity: 1; }

        #pause-btn { position: absolute; top: 80px; right: 5%; width: 45px; height: 45px; background: rgba(0,0,0,0.7); border: 2px solid white; color: white; border-radius: 50%; z-index: 200; cursor: pointer; }
        #jump-btn {
            position: absolute; right: 5%; bottom: 170px; z-index: 200;
            padding: 18px 25px; border-radius: 20px; border: 3px solid var(--gold);
            background: rgba(0,0,0,0.6); color: white; font-weight: 800; font-size: 18px;
            display: none; touch-action: none;
        }

        /* AJUSTES LANDSCAPE */
        @media (max-height: 500px) {
            #player { width: 80px; height: 80px; }
            #chao { height: 90px; }
            #jump-btn { bottom: 100px; right: 3%; padding: 12px 20px; }
            #menu-logo { width: 100px; margin-bottom: 10px; }
            .menu-group { flex-direction: row; flex-wrap: wrap; width: 95%; justify-content: center; gap: 8px; }
            .menu-btn { padding: 12px; font-size: 13px; min-width: 130px; }
            #story-msg { font-size: 16px; }
            #main-menu { padding-bottom: 20px; }
        }

        .overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: none; justify-content: center; align-items: center; flex-direction: column; z-index: 1000; background: rgba(0,0,0,0.9); color: white; text-align: center; }
    </style>
</head>
<body>

<div id="main-menu">
    <img src="../animal.gif" id="menu-logo">
    <h1 style="color: var(--gold); margin-top: 0; margin-bottom: 20px;">LA SAGA DE JOS√â</h1>
    <div class="menu-group">
        <button class="menu-btn" onclick="startGame('jornada', 'normal')">NORMAL</button>
        <button class="menu-btn" onclick="startGame('jornada', 'medio')">MEDIO</button>
        <button class="menu-btn" onclick="startGame('jornada', 'dificil')">DIF√çCIL</button>
        <button class="menu-btn btn-survival" onclick="startGame('sobrevivencia')">PUNTUACI√ìN</button>
    </div>
</div>

<div id="game-container">
    <div id="orientation-warning">üì± ¬°Se juega mejor con la pantalla horizontal!</div>

    <button id="pause-btn" onclick="togglePause(event)">||</button>
    <button id="jump-btn">SALTAR</button>
    <canvas id="chuva" style="position: absolute; top:0; left:0; z-index:20; pointer-events:none;"></canvas>
    
    <div id="ui-header">
        <div id="hud">
            <div id="vidas-box" class="hud-item">‚ù§‚ù§‚ù§</div>
            <div id="dist-box" class="hud-item" style="color: var(--gold);">0m</div>
            <div id="timer-box" class="hud-item">00:00</div>
        </div>
        <div id="progress-wrapper">
            <div id="progress-fill"></div>
            <div id="walker-container"><img src="../animal.gif" style="width: 100%;"></div>
        </div>
    </div>

    <div id="story-msg"></div>
    <div id="player"><img src="../animal.gif" style="width:100%;"></div>
    
    <img src="../arca.png" id="arca-final">
    
    <div id="chao"></div>

    <div id="win-screen" class="overlay">
        <h1 style="color: var(--gold);">¬°MISI√ìN CUMPLIDA!</h1>
        <button class="menu-btn" onclick="location.reload()">VOLVER AL MEN√ö</button>
    </div>

    <div id="lose-screen" class="overlay">
        <h1 style="color: var(--red);">FIN DE LA JORNADA</h1>
        <button class="menu-btn" onclick="location.reload()">INTENTAR DE NUEVO</button>
    </div>
</div>

<script>
    const canvas = document.getElementById('chuva'), ctx = canvas.getContext('2d');
    const player = document.getElementById('player'), container = document.getElementById('game-container');
    const jumpBtn = document.getElementById('jump-btn'), storyMsg = document.getElementById('story-msg');
    const arca = document.getElementById('arca-final');
    
    let gameActive = false, isPaused = false, vidas = 3;
    let playerY = 0, velocityY = 0, jumps = 0, gravity = 0.8;
    let obstacles = [], speed = 10, distance = 0, timeElapsed = 0;
    let totalDuration = 150, lastObstacleTime = 0, gameMode = 'jornada';
    let brightnessVal = 1;

    const frases = [
        { p: 1, t: "¬°La aventura ha comenzado! Lleva a Jos√© hasta el Arca." },
        { p: 15, t: "¬°No pierdas tiempo! Cada salto te acerca m√°s." },
        { p: 35, t: "Sigue adelante. El Arca est√° cada vez m√°s cerca." },
        { p: 55, t: "Ha ca√≠do la noche... ¬°falta muy poco para llegar!" },
        { p: 75, t: "¬°Ya se puede ver el Arca! ¬°No te rindas ahora!" },
        { p: 92, t: "¬°√öLTIMO TRAMO! ¬°ENTRA EN EL ARCA!" }
    ];

    if ('ontouchstart' in window) jumpBtn.style.display = "block";

    function startGame(mode, diff) {
        gameMode = mode;
        if(diff === 'medio') { speed = 13; totalDuration = 120; }
        if(diff === 'dificil') { speed = 16; totalDuration = 90; }
        
        document.getElementById('main-menu').style.display = 'none';
        container.style.display = 'block';
        gameActive = true;
        resizeCanvas();
        requestAnimationFrame(update);
        setInterval(tick, 1000);
    }

    function tick() {
        if(!gameActive || isPaused) return;
        timeElapsed++;
        let percent = (timeElapsed / totalDuration) * 100;
        
        document.getElementById('progress-fill').style.width = percent + "%";
        document.getElementById('walker-container').style.left = percent + "%";
        
        frases.forEach(f => { if(Math.floor(percent) === f.p) showStory(f.t); });
        
        let brightnessFactor = Math.abs((percent - 50) / 50);
        brightnessVal = 0.35 + (brightnessFactor * 0.65);
        container.style.filter = `brightness(${brightnessVal})`;

        if(gameMode === 'jornada') {
            let remain = Math.max(0, totalDuration - timeElapsed);
            document.getElementById('timer-box').innerText = `${Math.floor(remain/60)}:${(remain%60).toString().padStart(2,'0')}`;
            if(timeElapsed >= totalDuration) finishGame();
        } else {
            document.getElementById('timer-box').innerText = "‚àû";
            speed += 0.05;
        }
    }

    function showStory(txt) {
        storyMsg.innerText = txt;
        storyMsg.classList.add('active');
        setTimeout(() => storyMsg.classList.remove('active'), 3000);
    }

    function togglePause(e) {
        e.stopPropagation();
        isPaused = !isPaused;
        document.getElementById('pause-btn').innerText = isPaused ? "‚ñ∂" : "||";
    }

    function handleJump() {
        if(!gameActive || isPaused || jumps >= 2) return;
        
        if (jumps === 0) {
            velocityY = 14;
        } else {
            velocityY = 10;
        }
        
        jumps++;
    }

    function update(timestamp) {
        if(!gameActive) return;
        if(!isPaused) {
            velocityY -= gravity;
            playerY += velocityY;
            if (playerY <= 0) { playerY = 0; velocityY = 0; jumps = 0; }

            const hChao = document.getElementById('chao').offsetHeight;
            player.style.bottom = (hChao + playerY) + 'px';

            distance += (speed / 10);
            document.getElementById('dist-box').innerText = Math.floor(distance) + "m";

            if (timestamp - lastObstacleTime > (2000 - speed * 50)) {
                spawnObstacle();
                lastObstacleTime = timestamp;
            }
            moveObstacles();
            drawRain();
        }
        requestAnimationFrame(update);
    }

    function spawnObstacle() {
        const obs = document.createElement('div');
        obs.classList.add('rock');
        if(brightnessVal < 0.6) obs.classList.add('rock-glow');
        obs.style.right = '-60px';
        obs.style.bottom = document.getElementById('chao').offsetHeight + 'px';
        container.appendChild(obs);
        obstacles.push({ el: obs, x: -60 });
    }

    function moveObstacles() {
        for(let i = obstacles.length - 1; i >= 0; i--) {
            let o = obstacles[i];
            o.x += speed;
            o.el.style.right = o.x + 'px';

            let pRect = player.getBoundingClientRect();
            let oRect = o.el.getBoundingClientRect();

            if (pRect.right > oRect.left + 20 && pRect.left < oRect.right - 20 && pRect.bottom > oRect.top + 20) {
                o.el.remove();
                obstacles.splice(i, 1);
                vidas--;
                document.getElementById('vidas-box').innerText = "‚ù§".repeat(Math.max(0, vidas));
                if(vidas <= 0) { gameActive = false; document.getElementById('lose-screen').style.display = 'flex'; }
                continue;
            }
            if (o.x > window.innerWidth + 100) { o.el.remove(); obstacles.splice(i, 1); }
        }
    }

    function finishGame() {
        gameActive = false;
        arca.style.right = "10%";
        setTimeout(() => { document.getElementById('win-screen').style.display = 'flex'; }, 3500);
    }

    container.addEventListener('touchstart', (e) => {
        if(e.target.tagName !== 'BUTTON') handleJump();
    }, {passive: true});

    jumpBtn.addEventListener('touchstart', (e) => {
        e.preventDefault(); e.stopPropagation(); handleJump();
    }, {passive: false});

    window.addEventListener('keydown', (e) => { if(e.code === 'Space') handleJump(); });
    window.addEventListener('resize', resizeCanvas);

    function resizeCanvas() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; resetRain(); }
    let gotas = [];
    function resetRain() {
        gotas = [];
        for(let i=0; i<45; i++) gotas.push({x: Math.random()*canvas.width, y: Math.random()*canvas.height, v: Math.random()*7+7});
    }
    function drawRain() {
        ctx.clearRect(0,0,canvas.width,canvas.height);
        ctx.strokeStyle = `rgba(255,255,255,${0.1 + (1 - brightnessVal)})`;
        gotas.forEach(g => {
            ctx.beginPath(); ctx.moveTo(g.x, g.y); ctx.lineTo(g.x, g.y+12); ctx.stroke();
            g.y += g.v; if(g.y > canvas.height) g.y = -15;
        });
    }
</script>
</body>
</html>
