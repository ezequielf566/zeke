<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>A Saga de José - Equilibrado</title>
    <style>
        :root { --gold: #f1c40f; --neon-green: #2ecc71; --glow: #f1c40f; --red: #ff4757; }
        body, html { 
            margin: 0; padding: 0; width: 100%; height: 100%; 
            overflow: hidden; background: #000; font-family: 'Georgia', serif;
            user-select: none; -webkit-user-select: none;
        }

        #game-container{
            touch-action: none;
            -webkit-touch-callout: none;
            -webkit-tap-highlight-color: transparent;
        }

        #game-container {
            width: 100vw; height: 100vh;
            background: url('fundo.jpg') center/cover no-repeat;
            position: relative; overflow: hidden;
            transition: filter 1.2s linear;
            display: none;
        }
        
        #main-menu {
            width: 100vw; height: 100vh;
            background: linear-gradient(rgba(0,0,0,0.6), rgba(0,0,0,0.6)), url('fundo.jpg') center/cover;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            position: absolute; z-index: 500; text-align: center;
        }
        #menu-logo { width: 180px; margin-bottom: 20px; filter: drop-shadow(0 0 15px var(--gold)); }
        .menu-group { display: flex; flex-direction: column; gap: 12px; width: 280px; }

        .menu-btn {
            padding: 15px; border-radius: 50px; border: 2px solid var(--gold);
            background: rgba(0,0,0,0.8); color: white; font-weight: bold; cursor: pointer;
            transition: 0.3s; font-size: 16px;
        }
        .menu-btn:hover { background: var(--gold); color: black; }
        .btn-survival { border-color: var(--neon-green); }
        .btn-survival:hover { background: var(--neon-green); }

        #ui-header { position: absolute; top: 15px; width: 100%; display: flex; flex-direction: column; align-items: center; z-index: 100; pointer-events: none; }
        #hud { width: 90%; display: flex; justify-content: space-between; align-items: center; pointer-events: auto; }
        .hud-item {
            background: rgba(0,0,0,0.7); backdrop-filter: blur(8px);
            padding: 8px 15px; border-radius: 8px; border: 1px solid var(--gold);
            color: white; font-weight: bold; font-size: 14px; min-width: 80px; text-align: center;
        }

        #pause-btn {
            position: absolute; top: 80px; right: 5%; width: 45px; height: 45px;
            background: rgba(0,0,0,0.7); border: 2px solid white; color: white;
            border-radius: 50%; font-weight: bold; cursor: pointer; z-index: 110;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }

        #progress-wrapper { width: 80%; height: 12px; background: rgba(0,0,0,0.7); border-radius: 50px; border: 1px solid rgba(255,255,255,0.3); position: relative; margin-top: 10px; pointer-events: auto; }
        #progress-fill { height: 100%; width: 0%; background: linear-gradient(90deg, #1e8449, #f1c40f); border-radius: 50px; transition: width 1s linear; }
        #walker-container { position: absolute; left: 0%; top: 50%; transform: translate(-50%, -50%); width: 35px; height: 35px; transition: left 1s linear; }

        #player { width: 120px; height: 120px; position: absolute; bottom: 120px; left: 12%; z-index: 50; pointer-events: none; }
        #arca-final { position: absolute; bottom: 60px; right: -1000px; width: 600px; z-index: 40; transition: right 4s ease-out; pointer-events: none; }
        #chao { position: absolute; bottom: 0; width: 100%; height: 120px; background: linear-gradient(to bottom, #1e3d1a, #2c1e14); z-index: 10; pointer-events: none; }

        .rock-glow {
            background: var(--gold) !important;
            filter: drop-shadow(0 0 15px var(--gold));
            box-shadow: 0 0 30px var(--gold), inset 0 0 10px #fff !important;
        }

        .overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: none; justify-content: center; align-items: center; flex-direction: column; text-align: center; z-index: 1000; background: rgba(0,0,0,0.85); color: white; }
        #story-msg { position: absolute; top: 25%; width: 100%; text-align: center; color: white; font-size: 22px; font-weight: bold; text-shadow: 2px 2px 5px #000; opacity: 0; z-index: 150; pointer-events:none; }
        #story-msg.active { opacity: 1; }

        #jump-btn {
            position: absolute; right: 5%; bottom: 150px; z-index: 120;
            padding: 14px 18px; border-radius: 18px; border: 2px solid var(--gold);
            background: rgba(0,0,0,0.65); color: white; font-weight: 800;
            display: none; -webkit-tap-highlight-color: transparent; touch-action: manipulation;
        }

        /* AJUSTES PARA TELA DEITADA (LANDSCAPE) */
        @media (max-height: 500px) and (orientation: landscape) {
            #ui-header { top: 5px; }
            #hud { width: 95%; }
            .hud-item { padding: 4px 10px; font-size: 12px; min-width: 60px; }
            #progress-wrapper { height: 8px; margin-top: 5px; width: 60%; }
            #walker-container { width: 25px; height: 25px; }
            #player { width: 80px; height: 80px; bottom: 60px; }
            #chao { height: 60px; }
            #jump-btn { bottom: 20px; right: 2%; padding: 10px 15px; }
            #pause-btn { top: 10px; right: 2%; width: 35px; height: 35px; }
            #menu-logo { width: 80px; margin-bottom: 5px; }
            .menu-group { flex-direction: row; flex-wrap: wrap; justify-content: center; width: 90%; gap: 8px; }
            .menu-btn { padding: 8px 12px; font-size: 12px; width: auto; min-width: 100px; }
            #story-msg { font-size: 16px; top: 20%; }
        }
    </style>
</head>
<body>

<div id="main-menu">
    <img src="animal.gif" id="menu-logo">
    <h1 style="color: var(--gold); margin-bottom: 20px;">A SAGA DE JOSÉ</h1>
    <div class="menu-group">
        <button class="menu-btn" onclick="startGame('jornada', 'normal')">NORMAL</button>
        <button class="menu-btn" onclick="startGame('jornada', 'medio')">MÉDIO</button>
        <button class="menu-btn" onclick="startGame('jornada', 'dificil')">DIFÍCIL</button>
        <button class="menu-btn btn-survival" onclick="startGame('sobrevivencia')">PONTUAÇÃO</button>
    </div>
</div>

<div id="game-container">
    <button id="pause-btn" onclick="togglePause()" aria-label="Pausar">||</button>
    <button id="jump-btn" aria-label="Pular">PULAR</button>
    <canvas id="chuva" style="position: absolute; top:0; left:0; z-index:20; pointer-events:none;"></canvas>
    
    <div id="ui-header">
        <div id="hud">
            <div id="vidas" class="hud-item">❤❤❤</div>
            <div id="score-live" class="hud-item" style="color: var(--gold);">DISTÂNCIA: 0</div>
            <div id="timer" class="hud-item">00:00</div>
        </div>
        <div id="progress-wrapper">
            <div id="progress-fill"></div>
            <div id="walker-container"><img src="animal.gif" style="width: 100%;"></div>
        </div>
    </div>

    <div id="story-msg"></div>
    <div id="player"><img src="animal.gif" style="width:100%;"></div>
    <img src="arca.png" id="arca-final">
    <div id="chao"></div>

    <div id="win-screen" class="overlay">
        <h1 style="color: var(--gold);">MISSÃO CUMPRIDA!</h1>
        <div id="final-score" style="font-size: 40px; margin: 20px;">0</div>
        <button class="menu-btn" onclick="location.reload()">VOLTAR AO MENU</button>
    </div>

    <div id="lose-screen" class="overlay">
        <h1 style="color: var(--red);">FIM DA JORNADA</h1>
        <button class="menu-btn" onclick="location.reload()">TENTAR NOVAMENTE</button>
    </div>
</div>

<script>
    const canvas = document.getElementById('chuva'), ctx = canvas.getContext('2d');
    const player = document.getElementById('player'), container = document.getElementById('game-container');
    const progressFill = document.getElementById('progress-fill'), walkerIcon = document.getElementById('walker-container');
    const scoreLive = document.getElementById('score-live'), timerDisplay = document.getElementById('timer'), storyMsg = document.getElementById('story-msg');
    const jumpBtn = document.getElementById('jump-btn');
    const chaoElement = document.getElementById('chao');
    
    let gameActive = false, isPaused = false, vidas = 3, scoreBase = 0;
    let playerY = 0, velocityY = 0, jumps = 0, gravity = 1.2;
    let gameMode = 'jornada', difficulty = 'normal';
    let timeElapsed = 0, totalDuration = 150; 
    let currentBaseSpeed = 12, brightnessVal = 1;
    const MAX_JUMP_HEIGHT = 450; 

    const isMobile = matchMedia("(pointer: coarse)").matches || /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
    if (isMobile) jumpBtn.style.display = "block";

    const frases = [
        { p: 1, t: "A aventura começou! Leve o José até a Arca." },
        { p: 15, t: "Sem perder tempo! Cada salto te leva mais perto." },
        { p: 35, t: "Continue firme. A Arca está cada vez mais perto." },
        { p: 55, t: "A noite caiu… falta pouco para chegar!" },
        { p: 75, t: "Já dá pra ver a Arca! Não desista agora!" },
        { p: 92, t: "ÚLTIMA RAMPA! ENTRE NA ARCA!" }
    ];

    function startGame(mode, diff) {
        gameMode = mode; difficulty = diff;
        document.getElementById('main-menu').style.display = 'none';
        container.style.display = 'block';
        gameActive = true;
        totalDuration = 150; 

        if(mode === 'jornada') {
            if(diff === 'medio') { totalDuration = 120; currentBaseSpeed = 15; }
            if(diff === 'dificil') { totalDuration = 100; currentBaseSpeed = 18; }
        } else {
            timerDisplay.innerText = "∞";
            currentBaseSpeed = 12;
        }
        
        resizeCanvas();
        spawnObstacle();
        update();
        startTimer();
    }

    let timerInterval = null;
    function startTimer() {
        if (timerInterval) clearInterval(timerInterval);
        timerInterval = setInterval(() => {
            if(!gameActive || isPaused) return;
            timeElapsed++;
            scoreBase += 10;
            scoreLive.innerText = `DISTÂNCIA: ${scoreBase}`;
            let percent = (timeElapsed / totalDuration) * 100;
            
            if(gameMode === 'sobrevivencia') {
                if(percent >= 100) { timeElapsed = 0; percent = 0; }
                currentBaseSpeed += 0.04;
            } else {
                currentBaseSpeed += 0.02;
                frases.forEach(f => { if(Math.floor(percent) === f.p) showStory(f.t); });
                if(timeElapsed >= totalDuration) winGame();
            }

            progressFill.style.width = percent + "%";
            walkerIcon.style.left = percent + "%";

            let brightnessFactor = Math.abs((percent - 50) / 50);
            brightnessVal = 0.35 + (brightnessFactor * 0.65);
            container.style.filter = `brightness(${brightnessVal}) contrast(${1.1 + (1-brightnessFactor)*0.3})`;

            if(gameMode === 'jornada') {
                let left = Math.max(0, totalDuration - timeElapsed);
                timerDisplay.innerText = `${Math.floor(left/60)}:${(left%60).toString().padStart(2,'0')}`;
            }
        }, 1000);
    }

    function togglePause() {
        isPaused = !isPaused;
        document.getElementById('pause-btn').innerText = isPaused ? "▶" : "||";
    }

    function showStory(txt) {
        storyMsg.innerText = txt;
        storyMsg.classList.add('active');
        setTimeout(() => storyMsg.classList.remove('active'), 3000);
    }

    function update() {
        if(!gameActive) return;
        if(!isPaused) {
            velocityY -= gravity;
            playerY += velocityY;

            if (playerY <= 0) { 
                playerY = 0; velocityY = 0; jumps = 0; 
            }
            if (playerY > MAX_JUMP_HEIGHT) {
                playerY = MAX_JUMP_HEIGHT; velocityY = 0;
            }

            const hChao = chaoElement.offsetHeight;
            player.style.bottom = (hChao + playerY) + 'px';
            drawRain();
        }
        requestAnimationFrame(update);
    }

    function spawnObstacle() {
        if(!gameActive) return;
        if(!isPaused) {
            const rock = document.createElement('div');
            let speed = currentBaseSpeed + (Math.random() * 2);
            const hChao = chaoElement.offsetHeight;
            rock.style.cssText = `position:absolute; bottom:${hChao}px; width:50px; height:50px; background:#333; border-radius:10px; right:-100px; z-index:30;`;
            container.appendChild(rock);

            let pos = -100;
            let moveInterval = setInterval(() => {
                if(!gameActive) { rock.remove(); clearInterval(moveInterval); return; }
                if(!isPaused) {
                    if(brightnessVal < 0.65) rock.classList.add('rock-glow');
                    pos += speed;
                    rock.style.right = pos + 'px';

                    let pRect = player.getBoundingClientRect(), rRect = rock.getBoundingClientRect();
                    if (pRect.left+35 < rRect.right && pRect.right-35 > rRect.left && pRect.bottom > rRect.top+15) {
                        vidas--;
                        document.getElementById('vidas').innerText = "❤".repeat(Math.max(0, vidas));
                        rock.remove(); clearInterval(moveInterval);
                        if(vidas <= 0) gameOver();
                    }
                    if(pos > window.innerWidth + 150) { rock.remove(); clearInterval(moveInterval); }
                }
            }, 16);
        }
        let next = gameMode === 'sobrevivencia' ? Math.max(350, 1000 - scoreBase/200) : (difficulty === 'dificil' ? 600 : 900);
        setTimeout(spawnObstacle, next);
    }

    function winGame() {
        gameActive = false;
        document.getElementById('arca-final').style.right = "50px";
        setTimeout(() => {
            document.getElementById('win-screen').style.display = 'flex';
            document.getElementById('final-score').innerText = `DISTÂNCIA TOTAL: ${scoreBase}`;
        }, 3000);
    }

    function gameOver() {
        gameActive = false;
        document.getElementById('lose-screen').style.display = 'flex';
    }

    function resizeCanvas() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
    window.addEventListener('resize', resizeCanvas);
    window.addEventListener('orientationchange', resizeCanvas);

    let gotas = [];
    function resetRain() {
        gotas = [];
        for(let i=0; i<60; i++) gotas.push({x:Math.random()*canvas.width, y:Math.random()*canvas.height, v:Math.random()*10+10});
    }
    resetRain();

    function drawRain() {
        ctx.clearRect(0,0,canvas.width,canvas.height);
        ctx.strokeStyle = `rgba(255,255,255,${0.2 + (1 - brightnessVal)})`;
        gotas.forEach(g => {
            ctx.beginPath(); ctx.moveTo(g.x, g.y); ctx.lineTo(g.x, g.y+15); ctx.stroke();
            g.y += g.v; if(g.y > canvas.height) g.y = -20;
        });
    }

    function jump() {
        if(gameActive && !isPaused && jumps < 2) { 
            if (playerY < MAX_JUMP_HEIGHT) {
                velocityY = (jumps === 0) ? 22 : 16; 
                jumps++; 
            }
        }
    }

    function onPointerDown(e){
        if (!gameActive || isPaused) return;
        if (!!e.target.closest('button, #ui-header')) return;
        if (e.cancelable) e.preventDefault();
        jump();
    }

    container.addEventListener('pointerdown', onPointerDown, { passive: false });
    jumpBtn.addEventListener('pointerdown', (e) => {
        if (e.cancelable) e.preventDefault();
        jump();
    }, { passive: false });

    window.addEventListener('keydown', (e) => {
        if(e.code === 'Space' || e.code === 'Enter') { e.preventDefault(); jump(); }
    });
</script>
</body>
</html>
